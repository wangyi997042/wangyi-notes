
# 前端安全指南

# 一.常见web攻击
- XSS
- CSRF
- 点击劫持
- SQL注入
- OS注入
- 请求劫持
- DDOS


## 一、常见Web攻击类型

### 1. XSS (Cross Site Scripting) 跨站脚本攻击

**定义**：XSS (Cross-Site Scripting) 是指通过存在安全漏洞的Web网站，让注册用户的浏览器内运行非法的非本站点HTML标签或JavaScript进行的一种攻击。

**攻击分类**：
- **反射型**：URL参数直接注入
  - 示例：`http://localhost:3000/?from=<script>alert(3)</script>`
  - 特点：攻击代码通过URL参数传递，服务器将参数直接返回给用户浏览器执行
- **存储型**：存储到DB后读取时注入
  - 示例：评论框输入`<script>alert(1)</script>`
  - 特点：攻击代码被存储在服务器，所有访问该内容的用户都会受到攻击

**攻击危害**：
- 利用虚假输入表单骗取用户个人信息
- 利用脚本窃取用户的Cookie值，被害者在不知情的情况下，帮助攻击者发送恶意请求
- 显示伪造的文章或图片
- 获取页面数据
- 获取Cookies
- 劫持前端逻辑
- 发送请求
- 偷取网站的任意数据
- 偷取用户的资料和秘密
- 偷取用户的登录态
- 欺骗用户

### 2. CSRF (Cross Site Request Forgery) 跨站请求伪造

**定义**：CSRF (Cross Site Request Forgery) 是指利用用户已登录的身份，在用户毫不知情的情况下，以用户的名义完成非法操作的攻击。

**攻击流程**：
1. 用户已登录站点A，并在本地记录了cookie
2. 用户在未登出站点A的情况下，访问了恶意攻击者提供的危险站点B
3. 站点A没有做CSRF防御，攻击成功

**攻击危害**：
- 利用用户登录态
- 用户不知情完成业务请求
- 盗取用户资金（转账，消费）
- 冒充用户发帖
- 背锅
- 损害网站声誉

### 3. 点击劫持 (Clickjacking)

**定义**：点击劫持是一种视觉欺骗的攻击手段。攻击者将需要攻击的网站通过iframe嵌套的方式嵌入自己的网页中，并将iframe设置为透明，在页面中透出一个按钮诱导用户点击。

**防御手段**：
- `X-FRAME-OPTIONS` HTTP响应头
  - DENY：页面不允许通过iframe方式展示
  - SAMEORIGIN：页面可以在相同域名下通过iframe方式展示
  - ALLOW-FROM：页面可以在指定来源的iframe中展示
- JS方式
  ```html
  <head>
    <style id="click-jack">
      html { display: none !important; }
    </style>
  </head>
  <body>
    <script>
      if (self == top) {
        var style = document.getElementById('click-jack')
        document.body.removeChild(style)
      } else {
        top.location = self.location
      }
    </script>
  </body>
  ```

### 4. SQL注入

**定义**：SQL注入是指通过Web应用，执行非法的SQL语句，达到攻击目的。

**示例**：
- 输入特殊密码：`1'or'1'='1`
- 拼接后的SQL：`SELECT * FROM test.user WHERE username = 'laowang' AND password = '1'or'1'='1'`

**防范手段**：
- 使用参数化查询接口（不要直接拼接SQL语句）
  ```javascript
  // 错误写法
  const sql = `SELECT * FROM test.user WHERE username = '${ctx.request.body.username}' AND password = '${ctx.request.body.password}'`
  
  // 正确写法
  const sql = `SELECT * FROM test.user WHERE username = ? AND password = ?`
  res = await query(sql, [ctx.request.body.username, ctx.request.body.password])
  ```
- 严格限制Web应用的数据库操作权限
- 后端代码检查输入数据是否符合预期
- 对特殊字符进行转义处理

### 5. OS命令注入

**定义**：OS命令注入是指通过Web应用，执行非法的操作系统命令，达到攻击目的。

**示例**（Node.js）：
```javascript
const exec = require('mz/child_process').exec;
exec(`git clone ${params.repo} /some/path`);
```

**攻击**：`https://github.com/xx/xx.git && rm -rf /* &&`

### 6. 请求劫持

**类型**：
- **DNS劫持**：DNS服务器被篡改，修改域名解析结果
- **HTTP劫持**：运营商劫持，此时只能升级HTTPS

### 7. DDOS (Distributed Denial of Service)

**定义**：DDOS不是一种攻击，而是一大类攻击的总称，有几十种类型。

**常见攻击方式**：
- **SYN Flood**：向目标发送大量具有欺骗性源IP地址的SYN数据包
- **HTTP Flood**：大量HTTP请求泛滥服务器，导致拒绝服务

**防御手段**：
- 备份网站（最低限度可以显示公告）
- HTTP请求的拦截
- 高防IP
- 多个Docker硬件服务器
- 防火墙
- 带宽扩容 + CDN

## 二、安全防御手段

### 1. 密码安全

**泄露渠道**：
- 数据库被偷
- 服务器被入侵
- 通讯被窃听
- 内部人员泄露
- 其他网站（撞库）

**防御措施**：
- 严禁明文存储
- 单向变换
- 变换复杂度要求
- 密码复杂度要求
- 加盐（防拆解）
- 哈希算法
  - 雪崩效应：明文小幅变化，密文剧烈变化
  - 密文无法反推
  - 密文固定长度（md5、sha1、sha256）

**密码传输安全**：
- 使用HTTPS传输
- 频次限制
- 前端加密意义有限（传输层加密不会泄露，但不代表不能登录）

**示例代码**：
```javascript
const crypto = require('crypto')
const hash = (type, str) => crypto.createHash(type).update(str).digest('hex')
const md5 = str => hash('md5', str)
const sha1 = str => hash('sha1', str)
const encryptPassword = (salt, password) => md5(salt + 'abced@#4@%#$7' + password)
```

### 2. 人机验证与验证码

**实现原理**：
1. 服务端随机生成抠图和带有抠图阴影的背景图片
2. 前端实现滑动交互，将抠图拼在抠图阴影之上
3. 前端将用户滑动距离值传入服务端，服务端校验误差

### 3. HTTPS配置

**HTTP的弱点**：
- 窃听：密码、敏感信息
- 篡改：插入广告、重定向到其他网站
- 时代趋势：全球互联网正从HTTP向HTTPS迁移

**HTTPS特点**：
- 保密性（防泄密）
- 完整性（防篡改）
- 真实性（防假冒）

**HTTPS加密原理**：
- **对称加密**：密钥管理与分配问题
- **非对称加密**：公钥加密，私钥解密
  - 常见算法：RSA、Elgamal、ECC
  - RSA原理：大质数

**SSL证书**：
- 由浏览器中"受信任的根证书颁发机构"颁发
- 具有网站身份验证和加密传输双重功能

**配置步骤**：
1. 修改开发机hosts文件
2. 阿里云获取真实证书
3. Docker模拟nginx环境
4. 配置SSL证书
5. 实现HTTP -> HTTPS强制跳转

**SSL证书分类**：
- 入门级：DVSSL（域名有效，无门槛）
- 企业型：OVSSL（企业资质、个人认证）
- 增强型：EVSSL（浏览器绿色地址栏显示公司名字）

### 4. Helmet中间件

**作用**：提供多种安全HTTP响应头，增强前端安全性。

**常用配置**：
```javascript
const helmet = require("koa-helmet");
app.use(helmet());
```

**关键响应头**：
- `Strict-Transport-Security`：强制使用HTTPS
- `X-Frame-Options`：防止点击劫持
- `X-XSS-Protection`：开启XSS过滤
- `X-Content-Type-Options`：防止MIME-sniffing
- `Content-Security-Policy`：防止XSS攻击

### 5. Session管理

**安全使用Cookie**：
- `secure`：仅在HTTPS传输时传递cookie
- `HttpOnly`：禁止JavaScript获取cookie，防止XSS攻击
- `domain`：指定Cookie可用的域名
- `path`：指定Cookie可用的URL路径
- `expires`：设置持久化Cookie

### 6. 浏览器安全控制

**关键响应头**：
- `X-XSS-Protection`：防止反射型XSS
- `Strict-Transport-Security`：强制使用HTTPS通信
- `Content-Security-Policy`：防止XSS攻击

**CSP配置示例**：
```http
Content-Security-Policy: default-src 'self'; img-src https://*; child-src 'none';
```

## 三、安全实践总结

1. **输入验证**：永远不要信任用户输入，对输入进行严格验证和转义
2. **最小权限原则**：为数据库和应用分配最小必要权限
3. **安全配置**：使用Helmet中间件等工具配置安全响应头
4. **HTTPS强制**：使用HTTPS加密传输，防止窃听和篡改
5. **密码安全**：使用强哈希算法，加盐存储，避免明文存储
6. **XSS防护**：使用CSP、HttpOnly Cookie、转义输入输出
7. **CSRF防护**：使用CSRF Token、SameSite Cookie、Referer检查
8. **持续监控**：使用Sentry等工具监控前端异常
